# Next.js Type-Safe Routing & Layouts: Complete Guide From First Principles

## Table of Contents
1. [Understanding Next.js App Router Philosophy](#1-understanding-nextjs-app-router-philosophy)
2. [File-Based Routing Fundamentals](#2-file-based-routing-fundamentals)
3. [Special Files Deep Dive](#3-special-files-deep-dive)
4. [Layout System Mastery](#4-layout-system-mastery)
5. [Advanced Routing Patterns](#5-advanced-routing-patterns)
6. [Real-World Application Examples](#6-real-world-application-examples)
7. [Performance & Best Practices](#7-performance--best-practices)

---

## 1. Understanding Next.js App Router Philosophy

### The Core Problem: Routing Complexity
Traditional React applications require manual routing setup with libraries like React Router. This becomes complex as applications grow:

```tsx
// Traditional React Router - Manual configuration
function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Layout />}>
          <Route index element={<HomePage />} />
          <Route path="blog" element={<BlogLayout />}>
            <Route index element={<BlogListPage />} />
            <Route path=":slug" element={<BlogPostPage />} />
          </Route>
          <Route path="dashboard" element={<DashboardLayout />}>
            <Route index element={<DashboardHome />} />
            <Route path="settings" element={<SettingsPage />} />
          </Route>
        </Route>
      </Routes>
    </BrowserRouter>
  );
}
```

### The Next.js Solution: File-Based Routing
Next.js uses the file system to define routes automatically:

```
app/
├── page.tsx              → / (Home page)
├── layout.tsx            → Root layout for all pages
├── blog/
│   ├── page.tsx          → /blog (Blog listing)
│   ├── layout.tsx        → Layout for blog pages
│   └── [slug]/
│       └── page.tsx      → /blog/[slug] (Individual post)
└── dashboard/
    ├── page.tsx          → /dashboard
    ├── layout.tsx        → Dashboard layout
    └── settings/
        └── page.tsx      → /dashboard/settings
```

### First Principle: Convention Over Configuration
The App Router follows these principles:
- **File names determine functionality** (`page.tsx`, `layout.tsx`, etc.)
- **Folder structure determines URL structure**
- **Nested layouts compose automatically**
- **TypeScript provides compile-time safety**

---

## 2. File-Based Routing Fundamentals

### Basic Route Structure

```tsx
// app/page.tsx - Home page (/)
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Home | My App',
  description: 'Welcome to my application',
}

export default function HomePage() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <h1 className="text-4xl font-bold text-gray-900 mb-4">
          Welcome to My App
        </h1>
        <p className="text-xl text-gray-600">
          Built with Next.js and TypeScript
        </p>
      </div>
    </div>
  )
}
```

### Dynamic Routes with TypeScript

```tsx
// app/blog/[slug]/page.tsx - Dynamic blog post page
import type { Metadata } from 'next'
import { notFound } from 'next/navigation'

// Define the props interface for dynamic routes
interface BlogPostPageProps {
  params: {
    slug: string
  }
  searchParams: {
    [key: string]: string | string[] | undefined
  }
}

// Type-safe data fetching
interface BlogPost {
  id: string
  title: string
  content: string
  slug: string
  publishedAt: string
  author: {
    name: string
    avatar?: string
  }
}

async function getBlogPost(slug: string): Promise<BlogPost | null> {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/blog/${slug}`, {
      next: { revalidate: 3600 } // Revalidate every hour
    })
    
    if (!response.ok) {
      return null
    }
    
    return response.json()
  } catch (error) {
    console.error('Failed to fetch blog post:', error)
    return null
  }
}

// Generate metadata for SEO
export async function generateMetadata({ params }: BlogPostPageProps): Promise<Metadata> {
  const post = await getBlogPost(params.slug)
  
  if (!post) {
    return {
      title: 'Post Not Found'
    }
  }
  
  return {
    title: `${post.title} | Blog`,
    description: post.content.substring(0, 160),
    authors: [{ name: post.author.name }],
    openGraph: {
      title: post.title,
      description: post.content.substring(0, 160),
      type: 'article',
      publishedTime: post.publishedAt,
    }
  }
}

export default async function BlogPostPage({ params, searchParams }: BlogPostPageProps) {
  const post = await getBlogPost(params.slug)
  
  if (!post) {
    notFound() // This will render the not-found.tsx file
  }
  
  // Access search parameters with type safety
  const highlightText = typeof searchParams.highlight === 'string' 
    ? searchParams.highlight 
    : undefined
  
  return (
    <article className="max-w-4xl mx-auto py-8 px-4">
      <header className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-4">
          {post.title}
        </h1>
        
        <div className="flex items-center space-x-4 text-gray-600">
          <div className="flex items-center space-x-2">
            {post.author.avatar && (
              <img
                src={post.author.avatar}
                alt={post.author.name}
                className="w-8 h-8 rounded-full"
              />
            )}
            <span>By {post.author.name}</span>
          </div>
          
          <time dateTime={post.publishedAt}>
            {new Date(post.publishedAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        </div>
        
        {highlightText && (
          <div className="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500">
            <p className="text-sm text-yellow-800">
              Highlighting: "{highlightText}"
            </p>
          </div>
        )}
      </header>
      
      <div 
        className="prose prose-lg max-w-none"
        dangerouslySetInnerHTML={{ __html: post.content }}
      />
    </article>
  )
}

// Generate static params for static generation
export async function generateStaticParams(): Promise<{ slug: string }[]> {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/blog`)
    const posts: BlogPost[] = await response.json()
    
    return posts.map((post) => ({
      slug: post.slug
    }))
  } catch (error) {
    console.error('Failed to generate static params:', error)
    return []
  }
}
```

### Catch-All Routes

```tsx
// app/shop/[...slug]/page.tsx - Catch-all route for nested categories
interface ShopPageProps {
  params: {
    slug: string[] // Array of path segments
  }
  searchParams: {
    sort?: string
    filter?: string
    page?: string
  }
}

export default function ShopPage({ params, searchParams }: ShopPageProps) {
  const pathSegments = params.slug || []
  const currentPath = pathSegments.join('/')
  
  // Handle different path depths
  const breadcrumbs = pathSegments.map((segment, index) => ({
    name: segment.charAt(0).toUpperCase() + segment.slice(1),
    href: `/shop/${pathSegments.slice(0, index + 1).join('/')}`
  }))
  
  return (
    <div className="max-w-7xl mx-auto py-8 px-4">
      {/* Breadcrumb navigation */}
      <nav className="mb-6">
        <ol className="flex items-center space-x-2 text-sm">
          <li>
            <a href="/shop" className="text-blue-600 hover:text-blue-800">
              Shop
            </a>
          </li>
          {breadcrumbs.map((crumb, index) => (
            <li key={index} className="flex items-center space-x-2">
              <span className="text-gray-400">/</span>
              <a 
                href={crumb.href}
                className={`${
                  index === breadcrumbs.length - 1
                    ? 'text-gray-900 font-medium'
                    : 'text-blue-600 hover:text-blue-800'
                }`}
              >
                {crumb.name}
              </a>
            </li>
          ))}
        </ol>
      </nav>
      
      <h1 className="text-3xl font-bold mb-6">
        {pathSegments.length > 0 
          ? pathSegments[pathSegments.length - 1].charAt(0).toUpperCase() + 
            pathSegments[pathSegments.length - 1].slice(1)
          : 'All Products'
        }
      </h1>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <aside className="md:col-span-1">
          <h2 className="text-lg font-semibold mb-4">Filters</h2>
          {/* Filter components */}
        </aside>
        
        <main className="md:col-span-2">
          <div className="mb-4 flex justify-between items-center">
            <p className="text-gray-600">
              Showing products for: {currentPath || 'all categories'}
            </p>
            
            <select 
              defaultValue={searchParams.sort || 'name'}
              className="border rounded px-3 py-2"
            >
              <option value="name">Sort by Name</option>
              <option value="price-low">Price: Low to High</option>
              <option value="price-high">Price: High to Low</option>
            </select>
          </div>
          
          {/* Product grid */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {/* Products will be rendered here */}
          </div>
        </main>
      </div>
    </div>
  )
}
```

### Optional Catch-All Routes

```tsx
// app/docs/[[...slug]]/page.tsx - Optional catch-all for documentation
interface DocsPageProps {
  params: {
    slug?: string[] // Optional array
  }
}

export default function DocsPage({ params }: DocsPageProps) {
  const slug = params.slug || []
  
  // Handle root docs page
  if (slug.length === 0) {
    return (
      <div className="max-w-4xl mx-auto py-8">
        <h1 className="text-4xl font-bold mb-6">Documentation</h1>
        <p className="text-xl text-gray-600">
          Welcome to our documentation center
        </p>
      </div>
    )
  }
  
  // Handle nested documentation pages
  const docPath = slug.join('/')
  
  return (
    <div className="max-w-4xl mx-auto py-8">
      <h1 className="text-4xl font-bold mb-6">
        {slug[slug.length - 1].charAt(0).toUpperCase() + slug[slug.length - 1].slice(1)}
      </h1>
      <p>Documentation for: {docPath}</p>
    </div>
  )
}
```

---

## 3. Special Files Deep Dive

### `layout.tsx` - Persistent Layouts

```tsx
// app/layout.tsx - Root layout (required)
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import Header from '@/components/layout/Header'
import Footer from '@/components/layout/Footer'
import { ThemeProvider } from '@/components/providers/ThemeProvider'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: {
    default: 'My App',
    template: '%s | My App' // Page title | My App
  },
  description: 'A modern web application built with Next.js',
  keywords: ['Next.js', 'React', 'TypeScript'],
  authors: [{ name: 'Your Name' }],
  creator: 'Your Name',
  metadataBase: new URL('https://myapp.com'),
  openGraph: {
    type: 'website',
    locale: 'en_US',
    url: 'https://myapp.com',
    siteName: 'My App',
  },
  twitter: {
    card: 'summary_large_image',
    creator: '@yourusername',
  },
}

interface RootLayoutProps {
  children: React.ReactNode
}

export default function RootLayout({ children }: RootLayoutProps) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={inter.className}>
        <ThemeProvider>
          <div className="min-h-screen flex flex-col">
            <Header />
            <main className="flex-1">
              {children}
            </main>
            <Footer />
          </div>
        </ThemeProvider>
      </body>
    </html>
  )
}
```

### Nested Layouts

```tsx
// app/dashboard/layout.tsx - Dashboard-specific layout
import type { Metadata } from 'next'
import Sidebar from '@/components/dashboard/Sidebar'
import DashboardHeader from '@/components/dashboard/Header'
import { AuthProvider } from '@/components/providers/AuthProvider'

export const metadata: Metadata = {
  title: 'Dashboard',
  description: 'User dashboard area',
}

interface DashboardLayoutProps {
  children: React.ReactNode
}

export default function DashboardLayout({ children }: DashboardLayoutProps) {
  return (
    <AuthProvider>
      <div className="flex h-screen bg-gray-100">
        <Sidebar />
        
        <div className="flex-1 flex flex-col overflow-hidden">
          <DashboardHeader />
          
          <main className="flex-1 overflow-x-hidden overflow-y-auto p-6">
            <div className="max-w-7xl mx-auto">
              {children}
            </div>
          </main>
        </div>
      </div>
    </AuthProvider>
  )
}
```

### `loading.tsx` - Loading UI

```tsx
// app/loading.tsx - Global loading UI
export default function Loading() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p className="text-gray-600">Loading...</p>
      </div>
    </div>
  )
}
```

```tsx
// app/dashboard/loading.tsx - Dashboard-specific loading
export default function DashboardLoading() {
  return (
    <div className="space-y-6">
      {/* Header skeleton */}
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div className="h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
      </div>
      
      {/* Content skeletons */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <div key={i} className="bg-white rounded-lg shadow p-6">
            <div className="animate-pulse">
              <div className="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
              <div className="h-4 bg-gray-200 rounded w-full mb-2"></div>
              <div className="h-4 bg-gray-200 rounded w-2/3"></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

### `error.tsx` - Error Handling

```tsx
// app/error.tsx - Global error boundary
'use client' // Error components must be Client Components

import { useEffect } from 'react'

interface ErrorPageProps {
  error: Error & { digest?: string }
  reset: () => void
}

export default function Error({ error, reset }: ErrorPageProps) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error('Global error:', error)
  }, [error])

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center">
        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg
            className="h-6 w-6 text-red-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"
            />
          </svg>
        </div>
        
        <h2 className="text-lg font-medium text-gray-900 mb-2">
          Something went wrong!
        </h2>
        
        <p className="text-sm text-gray-500 mb-6">
          We encountered an unexpected error. Please try again.
        </p>
        
        <div className="space-y-3">
          <button
            onClick={reset}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            Try again
          </button>
          
          <button
            onClick={() => window.location.href = '/'}
            className="w-full bg-gray-200 text-gray-900 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
          >
            Go home
          </button>
        </div>
        
        {process.env.NODE_ENV === 'development' && (
          <details className="mt-6 text-left">
            <summary className="cursor-pointer text-sm text-gray-500">
              Error details (development only)
            </summary>
            <pre className="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded overflow-auto">
              {error.message}
              {error.stack && `\n\n${error.stack}`}
            </pre>
          </details>
        )}
      </div>
    </div>
  )
}
```

### `not-found.tsx` - 404 Pages

```tsx
// app/not-found.tsx - Global 404 page
import Link from 'next/link'

export default function NotFound() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full text-center">
        <div className="mb-8">
          <h1 className="text-9xl font-bold text-gray-200">404</h1>
          <h2 className="text-2xl font-bold text-gray-900 mb-2">
            Page not found
          </h2>
          <p className="text-gray-600">
            Sorry, we couldn't find the page you're looking for.
          </p>
        </div>
        
        <div className="space-y-4">
          <Link
            href="/"
            className="inline-block bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            Go back home
          </Link>
          
          <div>
            <Link
              href="/contact"
              className="text-blue-600 hover:text-blue-800 text-sm"
            >
              Contact support
            </Link>
          </div>
        </div>
      </div>
    </div>
  )
}
```

```tsx
// app/blog/not-found.tsx - Blog-specific 404 page
import Link from 'next/link'

export default function BlogNotFound() {
  return (
    <div className="max-w-4xl mx-auto py-16 px-4 text-center">
      <h1 className="text-4xl font-bold text-gray-900 mb-4">
        Blog Post Not Found
      </h1>
      
      <p className="text-xl text-gray-600 mb-8">
        The blog post you're looking for doesn't exist or has been moved.
      </p>
      
      <div className="space-y-4">
        <Link
          href="/blog"
          className="inline-block bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700"
        >
          Browse all posts
        </Link>
        
        <div>
          <Link
            href="/blog/search"
            className="text-blue-600 hover:text-blue-800"
          >
            Search blog posts
          </Link>
        </div>
      </div>
    </div>
  )
}
```

### `template.tsx` - Re-mounting Components

```tsx
// app/dashboard/template.tsx - Template that re-mounts on navigation
'use client'

import { motion } from 'framer-motion'
import { useEffect } from 'react'

interface DashboardTemplateProps {
  children: React.ReactNode
}

export default function DashboardTemplate({ children }: DashboardTemplateProps) {
  useEffect(() => {
    // This runs on every navigation within dashboard
    console.log('Dashboard page mounted')
    
    // Analytics tracking
    if (typeof window !== 'undefined') {
      // Track page view
      gtag('config', 'GA_MEASUREMENT_ID', {
        page_path: window.location.pathname,
      })
    }
  }, [])
  
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.2 }}
    >
      {children}
    </motion.div>
  )
}
```

---

## 4. Layout System Mastery

### Complex Nested Layout Structure

```tsx
// app/(marketing)/layout.tsx - Route group layout
import MarketingHeader from '@/components/marketing/Header'
import MarketingFooter from '@/components/marketing/Footer'

interface MarketingLayoutProps {
  children: React.ReactNode
}

export default function MarketingLayout({ children }: MarketingLayoutProps) {
  return (
    <div className="min-h-screen flex flex-col">
      <MarketingHeader />
      <main className="flex-1">
        {children}
      </main>
      <MarketingFooter />
    </div>
  )
}
```

```tsx
// app/(app)/dashboard/layout.tsx - App group dashboard layout
import { Suspense } from 'react'
import DashboardSidebar from '@/components/dashboard/Sidebar'
import DashboardHeader from '@/components/dashboard/Header'
import { AuthGuard } from '@/components/auth/AuthGuard'

interface DashboardLayoutProps {
  children: React.ReactNode
}

export default function DashboardLayout({ children }: DashboardLayoutProps) {
  return (
    <AuthGuard requiredRole="user">
      <div className="h-screen flex overflow-hidden bg-gray-100">
        <DashboardSidebar />
        
        <div className="flex flex-col w-0 flex-1 overflow-hidden">
          <DashboardHeader />
          
          <main className="flex-1 relative overflow-y-auto focus:outline-none">
            <div className="py-6">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                <Suspense fallback={<DashboardLoading />}>
                  {children}
                </Suspense>
              </div>
            </div>
          </main>
        </div>
      </div>
    </AuthGuard>
  )
}
```

### Layout with Multiple Slots

```tsx
// app/dashboard/layout.tsx - Layout with parallel routes
interface DashboardLayoutProps {
  children: React.ReactNode
  sidebar: React.ReactNode
  modal: React.ReactNode
}

export default function DashboardLayout({ 
  children, 
  sidebar, 
  modal 
}: DashboardLayoutProps) {
  return (
    <div className="h-screen flex">
      <aside className="w-64 bg-gray-900 text-white">
        {sidebar}
      </aside>
      
      <main className="flex-1 overflow-y-auto">
        {children}
      </main>
      
      {/* Modal slot for overlays */}
      {modal}
    </div>
  )
}
```

### Conditional Layouts

```tsx
// app/layout.tsx - Root layout with conditional rendering
import { headers } from 'next/headers'
import AdminLayout from '@/components/layouts/AdminLayout'
import UserLayout from '@/components/layouts/UserLayout'
import PublicLayout from '@/components/layouts/PublicLayout'

interface RootLayoutProps {
  children: React.ReactNode
}

export default function RootLayout({ children }: RootLayoutProps) {
  const headersList = headers()
  const pathname = headersList.get('x-pathname') || ''
  
  // Determine layout based on route
  if (pathname.startsWith('/admin')) {
    return (
      <html lang="en">
        <body>
          <AdminLayout>{children}</AdminLayout>
        </body>
      </html>
    )
  }
  
  if (pathname.startsWith('/dashboard') || pathname.startsWith('/profile')) {
    return (
      <html lang="en">
        <body>
          <UserLayout>{children}</UserLayout>
        </body>
      </html>
    )
  }
  
  return (
    <html lang="en">
      <body>
        <PublicLayout>{children}</PublicLayout>
      </body>
    </html>
  )
}
```

---

## 5. Advanced Routing Patterns

### Route Groups

```
app/
├── (marketing)/          # Route group - doesn't affect URL
│   ├── layout.tsx        # Marketing layout
│   ├── page.tsx          # / (home)
│   ├── about/
│   │   └── page.tsx      # /about
│   └── contact/
│       └── page.tsx      # /contact
├── (app)/                # App route group
│   ├── layout.tsx        # App layout
│   ├── dashboard/
│   │   └── page.tsx      # /dashboard
│   └── settings/
│       └── page.tsx      # /settings
└── admin/                # Regular folder - affects URL
    ├── layout.tsx
    └── page.tsx          # /admin
```

### Parallel Routes

```tsx
// app/dashboard/@sidebar/page.tsx - Sidebar slot
export default function DashboardSidebar() {
  return (
    <nav className="space-y-2">
      <a href="/dashboard" className="block px-4 py-2 rounded hover:bg-gray-100">
        Overview
      </a>
      <a href="/dashboard/analytics" className="block px-4 py-2 rounded hover:bg-gray-100">
        Analytics
      </a>
      <a href="/dashboard/settings" className="block px-4 py-2 rounded hover:bg-gray-100">
        Settings
      </a>
    </nav>
  )
}
```

```tsx
// app/dashboard/@modal/(..)photo/[id]/page.tsx - Intercepted route
import Modal from '@/components/ui/Modal'
import PhotoViewer from '@/components/PhotoViewer'

interface InterceptedPhotoPageProps {
  params: {
    id: string
  }
}

export default function InterceptedPhotoPage({ params }: InterceptedPhotoPageProps) {
  return (
    <Modal>
      <PhotoViewer photoId={params.id} />
    </Modal>
  )
}
```

### Route Intercepting

```tsx
// app/photos/[id]/page.tsx - Full page photo view
interface PhotoPageProps {
  params: {
    id: string
  }
}

export default function PhotoPage({ params }: PhotoPageProps) {
  return (
    <div className="min-h-screen bg-black flex items-center justify-center">
      <PhotoViewer photoId={params.id} />
    </div>
  )
}
```

```tsx
// app/@modal/(.)photos/[id]/page.tsx - Intercepted modal view
import Modal from '@/components/ui/Modal'
import PhotoViewer from '@/components/PhotoViewer'

interface ModalPhotoPageProps {
  params: {
    id: string
  }
}

export default function ModalPhotoPage({ params }: ModalPhotoPageProps) {
  return (
    <Modal>
      <PhotoViewer photoId={params.id} />
    </Modal>
  )
}
```

---

## 6. Real-World Application Examples

### Example 1: E-commerce Application Structure

```
app/
├── layout.tsx                    # Root layout
├── page.tsx                      # Home page
├── globals.css                   # Global styles
├── (marketing)/                  # Marketing pages
│   ├── layout.tsx               # Marketing layout
│   ├── about/page.tsx           # About page
│   └── contact/page.tsx         # Contact page
├── (shop)/                      # Shopping pages
│   ├── layout.tsx               # Shop layout with cart
│   ├── products/
│   │   ├── page.tsx             # Product listing
│   │   ├── loading.tsx          # Product loading
│   │   ├── [category]/
│   │   │   ├── page.tsx         # Category page
│   │   │   └── [subcategory]/
│   │   │       └── page.tsx     # Subcategory page
│   │   └── [id]/
│   │       ├── page.tsx         # Product detail
│   │       ├── loading.tsx      # Product detail loading
│   │       └── error.tsx        # Product error
│   ├── cart/
│   │   └── page.tsx             # Shopping cart
│   └── checkout/
│       ├── layout.tsx           # Checkout layout
│       ├── page.tsx             # Checkout step 1
│       ├── shipping/page.tsx    # Shipping info
│       ├── payment/page.tsx     # Payment info
│       └── confirmation/page.tsx # Order confirmation
├── (account)/                   # User account
│   ├── layout.tsx               # Account layout
│   ├── login/page.tsx           # Login page
│   ├── register/page.tsx        # Registration
│   ├── profile/
│   │   ├── page.tsx             # Profile overview
│   │   ├── edit/page.tsx        # Edit profile
│   │   └── orders/
│   │       ├── page.tsx         # Order history
│   │       └── [id]/page.tsx    # Order detail
│   └── settings/
│       ├── page.tsx             # Account settings
│       ├── password/page.tsx    # Change password
│       └── notifications/page.tsx # Notification settings
└── admin/                       # Admin panel
    ├── layout.tsx               # Admin layout
    ├── page.tsx                 # Admin dashboard
    ├── products/
    │   ├── page.tsx             # Manage products
    │   ├── new/page.tsx         # Create product
    │   └── [id]/
    │       ├── page.tsx         # Product detail
    │       └── edit/page.tsx    # Edit product
    ├── orders/
    │   ├── page.tsx             # Manage orders
    │   └── [id]/page.tsx        # Order detail
    └── users/
        ├── page.tsx             # Manage users
        └── [id]/page.tsx        # User detail
```

### Example 2: Complete E-commerce Shop Layout

```tsx
// app/(shop)/layout.tsx - Shop layout with cart functionality
import { Suspense } from 'react'
import ShopHeader from '@/components/shop/Header'
import CartSidebar from '@/components/shop/CartSidebar'
import { CartProvider } from '@/components/providers/CartProvider'

interface ShopLayoutProps {
  children: React.ReactNode
}

export default function ShopLayout({ children }: ShopLayoutProps) {
  return (
    <CartProvider>
      <div className="min-h-screen bg-gray-50">
        <ShopHeader />
        
        <div className="flex">
          <main className="flex-1 max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            {children}
          </main>
          
          <Suspense fallback={<div>Loading cart...</div>}>
            <CartSidebar />
          </Suspense>
        </div>
      </div>
    </CartProvider>
  )
}
```

```tsx
// app/(shop)/products/[id]/page.tsx - Product detail page
import type { Metadata } from 'next'
import { notFound } from 'next/navigation'
import Image from 'next/image'
import ProductImages from '@/components/product/ProductImages'
import ProductInfo from '@/components/product/ProductInfo'
import ProductReviews from '@/components/product/ProductReviews'
import RelatedProducts from '@/components/product/RelatedProducts'

interface Product {
  id: string
  name: string
  description: string
  price: number
  images: Array<{
    id: string
    url: string
    alt: string
  }>
  category: {
    id: string
    name: string
    slug: string
  }
  variants: Array<{
    id: string
    name: string
    value: string
    inStock: boolean
  }>
  reviews: {
    average: number
    count: number
  }
}

interface ProductPageProps {
  params: {
    id: string
  }
}

async function getProduct(id: string): Promise<Product | null> {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/products/${id}`, {
      next: { revalidate: 3600 }
    })
    
    if (!response.ok) {
      return null
    }
    
    return response.json()
  } catch (error) {
    console.error('Failed to fetch product:', error)
    return null
  }
}

export async function generateMetadata({ params }: ProductPageProps): Promise<Metadata> {
  const product = await getProduct(params.id)
  
  if (!product) {
    return {
      title: 'Product Not Found'
    }
  }
  
  return {
    title: `${product.name} | Shop`,
    description: product.description,
    openGraph: {
      title: product.name,
      description: product.description,
      images: product.images.map(img => ({
        url: img.url,
        alt: img.alt
      })),
      type: 'website',
    },
    twitter: {
      card: 'summary_large_image',
      title: product.name,
      description: product.description,
      images: [product.images[0]?.url],
    }
  }
}

export default async function ProductPage({ params }: ProductPageProps) {
  const product = await getProduct(params.id)
  
  if (!product) {
    notFound()
  }
  
  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: product.name,
    description: product.description,
    image: product.images.map(img => img.url),
    offers: {
      '@type': 'Offer',
      price: product.price,
      priceCurrency: 'USD',
      availability: 'https://schema.org/InStock'
    },
    aggregateRating: {
      '@type': 'AggregateRating',
      ratingValue: product.reviews.average,
      reviewCount: product.reviews.count
    }
  }
  
  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
      />
      
      <div className="bg-white">
        {/* Breadcrumb */}
        <nav className="py-4">
          <ol className="flex items-center space-x-2 text-sm">
            <li>
              <a href="/" className="text-gray-500 hover:text-gray-700">
                Home
              </a>
            </li>
            <li className="text-gray-400">/</li>
            <li>
              <a 
                href={`/products/${product.category.slug}`}
                className="text-gray-500 hover:text-gray-700"
              >
                {product.category.name}
              </a>
            </li>
            <li className="text-gray-400">/</li>
            <li className="text-gray-900 font-medium">
              {product.name}
            </li>
          </ol>
        </nav>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
          {/* Product Images */}
          <div>
            <ProductImages images={product.images} alt={product.name} />
          </div>
          
          {/* Product Info */}
          <div>
            <ProductInfo product={product} />
          </div>
        </div>
        
        {/* Product Description */}
        <div className="border-t border-gray-200 pt-8 mb-12">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">
            Description
          </h2>
          <div 
            className="prose prose-lg max-w-none"
            dangerouslySetInnerHTML={{ __html: product.description }}
          />
        </div>
        
        {/* Reviews */}
        <div className="border-t border-gray-200 pt-8 mb-12">
          <ProductReviews productId={product.id} />
        </div>
        
        {/* Related Products */}
        <div className="border-t border-gray-200 pt-8">
          <RelatedProducts 
            categoryId={product.category.id} 
            excludeId={product.id} 
          />
        </div>
      </div>
    </>
  )
}
```

### Example 3: Multi-tenant Dashboard Application

```tsx
// app/[tenant]/layout.tsx - Tenant-specific layout
import { notFound } from 'next/navigation'
import TenantHeader from '@/components/tenant/Header'
import TenantSidebar from '@/components/tenant/Sidebar'
import { TenantProvider } from '@/components/providers/TenantProvider'

interface TenantLayoutProps {
  children: React.ReactNode
  params: {
    tenant: string
  }
}

async function getTenant(slug: string) {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/tenants/${slug}`)
    
    if (!response.ok) {
      return null
    }
    
    return response.json()
  } catch (error) {
    return null
  }
}

export default async function TenantLayout({ children, params }: TenantLayoutProps) {
  const tenant = await getTenant(params.tenant)
  
  if (!tenant) {
    notFound()
  }
  
  return (
    <TenantProvider tenant={tenant}>
      <div className="h-screen flex bg-gray-100">
        <TenantSidebar />
        
        <div className="flex-1 flex flex-col overflow-hidden">
          <TenantHeader />
          
          <main className="flex-1 overflow-y-auto">
            <div className="py-6">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                {children}
              </div>
            </div>
          </main>
        </div>
      </div>
    </TenantProvider>
  )
}
```

```tsx
// app/[tenant]/dashboard/page.tsx - Tenant dashboard
interface TenantDashboardProps {
  params: {
    tenant: string
  }
}

export default function TenantDashboard({ params }: TenantDashboardProps) {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">
          Dashboard - {params.tenant}
        </h1>
        <p className="text-gray-600">
          Welcome to your {params.tenant} dashboard
        </p>
      </div>
      
      {/* Dashboard content */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Dashboard cards */}
      </div>
    </div>
  )
}
```

---

## 7. Performance & Best Practices

### Layout Optimization

```tsx
// app/layout.tsx - Optimized root layout
import { Inter } from 'next/font/google'
import { Metadata } from 'next'

// Font optimization
const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  preload: true,
})

export const metadata: Metadata = {
  title: {
    default: 'My App',
    template: '%s | My App'
  },
  description: 'A modern web application',
  metadataBase: new URL(process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'),
}

interface RootLayoutProps {
  children: React.ReactNode
}

export default function RootLayout({ children }: RootLayoutProps) {
  return (
    <html lang="en" className={inter.className}>
      <body>
        {/* Skip to main content for accessibility */}
        <a 
          href="#main-content" 
          className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded"
        >
          Skip to main content
        </a>
        
        <div id="root">
          {children}
        </div>
        
        {/* Portal for modals */}
        <div id="modal-root" />
      </body>
    </html>
  )
}
```

### Streaming and Suspense

```tsx
// app/dashboard/page.tsx - Dashboard with streaming
import { Suspense } from 'react'
import DashboardStats from '@/components/dashboard/Stats'
import RecentActivity from '@/components/dashboard/RecentActivity'
import QuickActions from '@/components/dashboard/QuickActions'

function StatsLoading() {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      {[...Array(3)].map((_, i) => (
        <div key={i} className="bg-white p-6 rounded-lg shadow animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
          <div className="h-8 bg-gray-200 rounded w-3/4"></div>
        </div>
      ))}
    </div>
  )
}

function ActivityLoading() {
  return (
    <div className="bg-white rounded-lg shadow p-6">
      <div className="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>
      {[...Array(5)].map((_, i) => (
        <div key={i} className="flex items-center space-x-4 mb-4 animate-pulse">
          <div className="h-10 w-10 bg-gray-200 rounded-full"></div>
          <div className="flex-1">
            <div className="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div className="h-3 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
      ))}
    </div>
  )
}

export default function DashboardPage() {
  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
        <p className="text-gray-600">Welcome back! Here's what's happening.</p>
      </div>
      
      {/* Stats section - loads first */}
      <Suspense fallback={<StatsLoading />}>
        <DashboardStats />
      </Suspense>
      
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Recent activity - loads independently */}
        <Suspense fallback={<ActivityLoading />}>
          <RecentActivity />
        </Suspense>
        
        {/* Quick actions - loads immediately */}
        <QuickActions />
      </div>
    </div>
  )
}
```

### Error Boundary Best Practices

```tsx
// components/ErrorBoundary.tsx - Reusable error boundary
'use client'

import { Component, ErrorInfo, ReactNode } from 'react'

interface Props {
  children: ReactNode
  fallback?: ReactNode
  onError?: (error: Error, errorInfo: ErrorInfo) => void
}

interface State {
  hasError: boolean
  error?: Error
}

export class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false
  }

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error }
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo)
    this.props.onError?.(error, errorInfo)
  }

  public render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="min-h-[200px] flex items-center justify-center">
          <div className="text-center">
            <h2 className="text-lg font-semibold text-gray-900 mb-2">
              Something went wrong
            </h2>
            <p className="text-gray-600 mb-4">
              We're sorry, but something unexpected happened.
            </p>
            <button
              onClick={() => this.setState({ hasError: false })}
              className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            >
              Try again
            </button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}
```

### Best Practices Summary

1. **Layout Hierarchy**
   - Use nested layouts for common UI elements
   - Keep layouts focused on structure, not business logic
   - Implement proper error boundaries at layout level

2. **Performance**
   - Use Suspense for streaming content
   - Implement proper loading states
   - Optimize fonts and static assets

3. **Type Safety**
   - Always type props interfaces
   - Use proper metadata types
   - Implement type-safe routing with params

4. **User Experience**
   - Provide meaningful loading states
   - Implement graceful error handling
   - Use proper accessibility features

5. **SEO & Metadata**
   - Generate dynamic metadata
   - Implement structured data
   - Use proper Open Graph tags

This comprehensive guide provides everything needed to build production-ready Next.js applications with type-safe routing and layouts, from basic concepts to advanced patterns with real-world examples.
